{% layout "base" %}

{% assign page_type = "blog" %}
{% assign page_url = post.url | default: "/blog" %}

<article class="blog-post">
    {% if post %}
    <!-- Single Blog Post -->
    <header class="post-header">
        <h1>{{ post.title }}</h1>
        {% include 'post-meta' %}
    </header>
    
    <div class="post-content">
        {{ post.content }}
    </div>
    
    {% include 'post-navigation' %}
    
    {% else %}
    <!-- Blog Index -->
    <header class="blog-header">
        {% assign hero_title = "Blog Posts" %}
        {% assign hero_subtitle = "Thoughts on software development, AI, and technology" %}
        <h1>{{ hero_title }}</h1>
        <p class="blog-subtitle">{{ hero_subtitle }}</p>
    </header>
    
    {% if posts and posts.size > 0 %}
    <!-- Filter Section -->
    <div class="content-filters">
        <div class="filter-header">
            <h3>Filter by topic</h3>
            <button class="filter-clear" onclick="clearAllFilters()">Clear all</button>
        </div>
        
        {% assign all_tags = posts | unique_tags %}
        {% if all_tags.size > 0 %}
        <div class="tag-filters" data-filter-group="tags">
            <button class="filter-tag active" data-filter="all">All Posts</button>
            {% for tag in all_tags %}
            <button class="filter-tag" data-filter="{{ tag | slug }}">{{ tag }}</button>
            {% endfor %}
        </div>
        {% endif %}
        
        <!-- Search input -->
        <div class="search-container">
            <input 
                type="search" 
                id="content-search" 
                placeholder="Search posts..." 
                aria-label="Search blog posts"
            />
            <button type="button" onclick="clearSearch()" class="search-clear" aria-label="Clear search">×</button>
        </div>
    </div>
    <div class="posts-grid" id="posts-container">
        {% for post_item in posts %}
        <article class="post-preview" 
                data-tags="{% for tag in post_item.tags %}{{ tag | slug }}{% unless forloop.last %},{% endunless %}{% endfor %}"
                data-title="{{ post_item.title | downcase }}"
                data-excerpt="{{ post_item.excerpt | downcase }}">
            <header class="post-preview-header">
                <h2><a href="{{ post_item.url }}">{{ post_item.title }}</a></h2>
                <div class="preview-meta">
                    <time datetime="{{ post_item.publishDate }}">
                        {{ post_item.publishDate | date_format: "short" }}
                    </time>
                    {% if post_item.reading_time %}
                    <span class="meta-separator">•</span>
                    <span class="reading-time">{{ post_item.reading_time }}</span>
                    {% endif %}
                </div>
            </header>
            
            <div class="post-excerpt">
                {{ post_item.excerpt }}
            </div>
            
            {% if post_item.tags and post_item.tags.size > 0 %}
            <div class="preview-tags">
                {% for tag in post_item.tags %}
                <span class="tag">{{ tag }}</span>
                {% endfor %}
            </div>
            {% endif %}
            
            <footer class="post-preview-footer">
                <a href="{{ post_item.url }}" class="read-more">Read more →</a>
            </footer>
        </article>
        {% endfor %}
    </div>
    
    <!-- No results message (hidden by default) -->
    <div class="no-results" id="no-results">
        <p>No posts found matching your criteria.</p>
        <button onclick="clearAllFilters()" class="filter-clear">Show all posts</button>
    </div>
    
    {% else %}
    <div class="no-posts">
        <p>No blog posts available yet.</p>
        <p><a href="/#projects">Check out my projects instead →</a></p>
    </div>
    {% endif %}
    {% endif %}
</article>

<style>
/* Blog-specific styles */
.blog-header {
    text-align: center;
    margin-bottom: 3rem;
}

.blog-header h1 {
    font-family: 'JetBrains Mono', monospace;
    font-size: 3rem;
    margin-bottom: 1rem;
}

.blog-subtitle {
    font-size: 1.2rem;
    color: hsl(var(--muted-foreground));
    margin: 0;
}

.post-header {
    margin-bottom: 2rem;
}

.post-header h1 {
    font-size: 2.5rem;
    margin-bottom: 1rem;
    line-height: 1.2;
}

.post-content {
    font-size: 1.1rem;
    line-height: 1.8;
}

.post-content h1:first-child,
.post-content h2:first-child,
.post-content h3:first-child {
    margin-top: 0;
}

/* Blog Index Grid */
.posts-grid {
    display: grid;
    gap: 2rem;
    margin-bottom: 3rem;
}

.post-preview {
    padding: 1.5rem;
    border: 1px solid hsl(var(--border));
    border-radius: 0.5rem;
    transition: all 0.2s;
}

.post-preview:hover {
    border-color: hsl(var(--accent-green));
    background: hsl(var(--muted) / 0.3);
}

.post-preview-header h2 {
    margin-top: 0;
    margin-bottom: 0.5rem;
    font-size: 1.5rem;
    border: none;
    padding: 0;
}

.post-preview-header h2 a {
    color: hsl(var(--accent-orange));
    text-decoration: none;
}

.post-preview-header h2 a:hover {
    color: hsl(var(--accent-green));
}

.preview-meta {
    font-size: 0.875rem;
    color: hsl(var(--muted-foreground));
    margin-bottom: 1rem;
}

.meta-separator {
    color: hsl(var(--border));
}

.post-excerpt {
    margin-bottom: 1rem;
    color: hsl(var(--foreground));
    line-height: 1.6;
}

.preview-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.post-preview-footer .read-more {
    color: hsl(var(--accent-green));
    font-weight: 500;
    font-size: 0.875rem;
}

.post-preview-footer .read-more:hover {
    color: hsl(var(--accent-orange));
}

.no-posts {
    text-align: center;
    padding: 3rem 0;
    color: hsl(var(--muted-foreground));
}

.no-posts p {
    margin-bottom: 1rem;
}

/* Content Filtering Styles */
.content-filters {
    margin-bottom: 2rem;
    padding: 1.5rem;
    background: hsl(var(--muted) / 0.3);
    border-radius: 0.5rem;
    border: 1px solid hsl(var(--border));
}

.filter-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.filter-header h3 {
    margin: 0;
    font-size: 1.1rem;
    color: hsl(var(--foreground));
}

.filter-clear {
    background: none;
    border: none;
    color: hsl(var(--muted-foreground));
    cursor: pointer;
    font-size: 0.875rem;
    text-decoration: underline;
}

.filter-clear:hover {
    color: hsl(var(--accent-orange));
}

.tag-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.filter-tag {
    padding: 0.5rem 1rem;
    border: 1px solid hsl(var(--border));
    border-radius: 2rem;
    background: hsl(var(--background));
    color: hsl(var(--foreground));
    cursor: pointer;
    font-size: 0.875rem;
    transition: all 0.2s;
}

.filter-tag:hover {
    border-color: hsl(var(--accent-green));
    background: hsl(var(--accent-green) / 0.1);
}

.filter-tag.active {
    background: hsl(var(--accent-green));
    color: hsl(var(--background));
    border-color: hsl(var(--accent-green));
}

.search-container {
    position: relative;
    max-width: 300px;
}

.search-container input {
    width: 100%;
    padding: 0.75rem 2.5rem 0.75rem 1rem;
    border: 1px solid hsl(var(--border));
    border-radius: 0.5rem;
    background: hsl(var(--background));
    color: hsl(var(--foreground));
    font-size: 0.875rem;
}

.search-container input:focus {
    outline: none;
    border-color: hsl(var(--accent-green));
    box-shadow: 0 0 0 2px hsl(var(--accent-green) / 0.2);
}

.search-clear {
    position: absolute;
    right: 0.5rem;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: hsl(var(--muted-foreground));
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0.25rem;
    line-height: 1;
}

.search-clear:hover {
    color: hsl(var(--accent-orange));
}

/* Hidden posts during filtering */
.post-preview.filtered-hidden {
    display: none;
}

/* No results message */
.no-results {
    text-align: center;
    padding: 2rem;
    color: hsl(var(--muted-foreground));
    display: none;
}

.no-results.show {
    display: block;
}

/* Responsive */
@media (max-width: 768px) {
    .blog-header h1 {
        font-size: 2rem;
    }
    
    .post-header h1 {
        font-size: 2rem;
    }
    
    .post-preview {
        padding: 1rem;
    }
    
    .content-filters {
        padding: 1rem;
    }
    
    .filter-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .search-container {
        max-width: 100%;
    }
}
</style>

<script>
// Optimized content filtering and search functionality with accessibility
(function() {
    let currentTagFilter = 'all';
    let currentSearchTerm = '';
    let searchDebounceTimer = null;
    let isFilteringInProgress = false;
    
    // Cached DOM elements for performance
    let cachedElements = {};
    
    // Debounce function for search input
    function debounce(func, wait) {
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(searchDebounceTimer);
                func(...args);
            };
            clearTimeout(searchDebounceTimer);
            searchDebounceTimer = setTimeout(later, wait);
        };
    }
    
    // Cache frequently accessed DOM elements
    function cacheElements() {
        cachedElements = {
            posts: document.querySelectorAll('.post-preview'),
            tagButtons: document.querySelectorAll('.filter-tag'),
            searchInput: document.getElementById('content-search'),
            noResults: document.getElementById('no-results'),
            postsContainer: document.getElementById('posts-container'),
            // Create live region for screen reader announcements
            liveRegion: createLiveRegion()
        };
    }
    
    // Create ARIA live region for screen reader announcements
    function createLiveRegion() {
        let liveRegion = document.getElementById('filter-announcements');
        if (!liveRegion) {
            liveRegion = document.createElement('div');
            liveRegion.id = 'filter-announcements';
            liveRegion.setAttribute('aria-live', 'polite');
            liveRegion.setAttribute('aria-atomic', 'true');
            liveRegion.style.position = 'absolute';
            liveRegion.style.left = '-10000px';
            liveRegion.style.width = '1px';
            liveRegion.style.height = '1px';
            liveRegion.style.overflow = 'hidden';
            document.body.appendChild(liveRegion);
        }
        return liveRegion;
    }
    
    // Initialize filters when page loads
    document.addEventListener('DOMContentLoaded', function() {
        cacheElements();
        initializeFilters();
        initializeSearch();
        initializeKeyboardNavigation();
        enhanceAccessibility();
    });
    
    function initializeFilters() {
        cachedElements.tagButtons.forEach((button, index) => {
            // Add ARIA attributes
            button.setAttribute('role', 'button');
            button.setAttribute('aria-pressed', button.classList.contains('active') ? 'true' : 'false');
            button.setAttribute('tabindex', '0');
            
            button.addEventListener('click', function() {
                const filter = this.getAttribute('data-filter');
                setTagFilter(filter);
                updateActiveButton(this);
                debouncedApplyFilters();
            });
            
            // Keyboard support for filter buttons
            button.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    this.click();
                }
                // Arrow key navigation
                if (e.key === 'ArrowRight' || e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navigateFilterButtons(e.key === 'ArrowRight' ? 1 : -1, index);
                }
            });
        });
    }
    
    function initializeSearch() {
        if (cachedElements.searchInput) {
            // Add ARIA attributes
            cachedElements.searchInput.setAttribute('aria-describedby', 'search-help');
            
            // Create search help text
            if (!document.getElementById('search-help')) {
                const helpText = document.createElement('div');
                helpText.id = 'search-help';
                helpText.className = 'sr-only';
                helpText.textContent = 'Search by post title or content. Results update as you type.';
                cachedElements.searchInput.parentNode.appendChild(helpText);
            }
            
            cachedElements.searchInput.addEventListener('input', debouncedHandleSearch);
        }
    }
    
    // Debounced search handler for better performance
    const debouncedHandleSearch = debounce(function() {
        currentSearchTerm = cachedElements.searchInput.value.toLowerCase().trim();
        applyFilters();
    }, 300);
    
    // Debounced filter application
    const debouncedApplyFilters = debounce(applyFilters, 100);
    
    function initializeKeyboardNavigation() {
        // Enable keyboard navigation for filter container
        const filterContainer = document.querySelector('.tag-filters');
        if (filterContainer) {
            filterContainer.setAttribute('role', 'toolbar');
            filterContainer.setAttribute('aria-label', 'Filter posts by tag');
        }
    }
    
    function enhanceAccessibility() {
        // Add screen reader only helper text
        const srHelper = document.createElement('div');
        srHelper.className = 'sr-only';
        srHelper.id = 'filter-instructions';
        srHelper.textContent = 'Use tab to navigate filter buttons, enter or space to activate, arrow keys to move between filters.';
        
        const filtersContainer = document.querySelector('.content-filters');
        if (filtersContainer) {
            filtersContainer.insertBefore(srHelper, filtersContainer.firstChild);
            filtersContainer.setAttribute('aria-describedby', 'filter-instructions');
        }
    }
    
    function navigateFilterButtons(direction, currentIndex) {
        const buttons = Array.from(cachedElements.tagButtons);
        let newIndex = currentIndex + direction;
        
        if (newIndex < 0) newIndex = buttons.length - 1;
        if (newIndex >= buttons.length) newIndex = 0;
        
        buttons[newIndex].focus();
    }
    
    function setTagFilter(filter) {
        currentTagFilter = filter;
    }
    
    function updateActiveButton(activeButton) {
        cachedElements.tagButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.setAttribute('aria-pressed', 'false');
        });
        activeButton.classList.add('active');
        activeButton.setAttribute('aria-pressed', 'true');
    }
    
    function applyFilters() {
        if (isFilteringInProgress) return;
        isFilteringInProgress = true;
        
        // Use requestAnimationFrame for smooth UI updates
        requestAnimationFrame(() => {
            let visibleCount = 0;
            const totalPosts = cachedElements.posts.length;
            
            cachedElements.posts.forEach(post => {
                const shouldShow = matchesFilters(post);
                
                if (shouldShow) {
                    post.classList.remove('filtered-hidden');
                    post.removeAttribute('aria-hidden');
                    visibleCount++;
                } else {
                    post.classList.add('filtered-hidden');
                    post.setAttribute('aria-hidden', 'true');
                }
            });
            
            // Show/hide no results message
            if (cachedElements.noResults) {
                if (visibleCount === 0) {
                    cachedElements.noResults.classList.add('show');
                    cachedElements.noResults.removeAttribute('aria-hidden');
                    cachedElements.noResults.setAttribute('tabindex', '0');
                } else {
                    cachedElements.noResults.classList.remove('show');
                    cachedElements.noResults.setAttribute('aria-hidden', 'true');
                    cachedElements.noResults.removeAttribute('tabindex');
                }
            }
            
            // Announce results to screen readers
            announceResults(visibleCount, totalPosts);
            
            isFilteringInProgress = false;
        });
    }
    
    function announceResults(visibleCount, totalPosts) {
        if (!cachedElements.liveRegion) return;
        
        let announcement = '';
        if (visibleCount === 0) {
            announcement = 'No posts found matching your criteria.';
        } else if (visibleCount === totalPosts) {
            announcement = `Showing all ${totalPosts} posts.`;
        } else {
            announcement = `Showing ${visibleCount} of ${totalPosts} posts.`;
        }
        
        // Add filter context to announcement
        if (currentTagFilter !== 'all') {
            const activeButton = document.querySelector('.filter-tag.active');
            const tagName = activeButton ? activeButton.textContent.trim() : currentTagFilter;
            announcement += ` Filtered by tag: ${tagName}.`;
        }
        
        if (currentSearchTerm) {
            announcement += ` Search term: ${currentSearchTerm}.`;
        }
        
        cachedElements.liveRegion.textContent = announcement;
    }
    
    function matchesFilters(post) {
        // Optimized filter matching with cached data attributes
        const postData = getPostData(post);
        return matchesTagFilter(postData) && matchesSearchTerm(postData);
    }
    
    // Cache post data for better performance
    const postDataCache = new Map();
    function getPostData(post) {
        if (!postDataCache.has(post)) {
            postDataCache.set(post, {
                tags: (post.getAttribute('data-tags') || '').split(',').filter(Boolean),
                title: (post.getAttribute('data-title') || '').toLowerCase(),
                excerpt: (post.getAttribute('data-excerpt') || '').toLowerCase()
            });
        }
        return postDataCache.get(post);
    }
    
    function matchesTagFilter(postData) {
        if (currentTagFilter === 'all') return true;
        return postData.tags.includes(currentTagFilter);
    }
    
    function matchesSearchTerm(postData) {
        if (!currentSearchTerm) return true;
        return postData.title.includes(currentSearchTerm) || postData.excerpt.includes(currentSearchTerm);
    }
    
    // Global functions for button clicks with accessibility
    window.clearAllFilters = function() {
        currentTagFilter = 'all';
        currentSearchTerm = '';
        
        // Reset search input
        if (cachedElements.searchInput) {
            cachedElements.searchInput.value = '';
        }
        
        // Reset active tag button
        const allButton = document.querySelector('.filter-tag[data-filter="all"]');
        if (allButton) {
            updateActiveButton(allButton);
            allButton.focus(); // Maintain focus for keyboard users
        }
        
        applyFilters();
    };
    
    window.clearSearch = function() {
        currentSearchTerm = '';
        if (cachedElements.searchInput) {
            cachedElements.searchInput.value = '';
            cachedElements.searchInput.focus(); // Return focus to search input
        }
        applyFilters();
    };
    
    // Add CSS for screen reader only content
    if (!document.getElementById('sr-only-styles')) {
        const srStyles = document.createElement('style');
        srStyles.id = 'sr-only-styles';
        srStyles.textContent = `
            .sr-only {
                position: absolute !important;
                width: 1px !important;
                height: 1px !important;
                padding: 0 !important;
                margin: -1px !important;
                overflow: hidden !important;
                clip: rect(0, 0, 0, 0) !important;
                white-space: nowrap !important;
                border: 0 !important;
            }
        `;
        document.head.appendChild(srStyles);
    }
})();
</script>